<style>
    /* Hide core "Update Now" and "Add to Playlist" buttons for this plugin (UI-only, no display/playlist use) */
    #settingsForm>.buttons-container {
        display: none !important;
    }

    .plugin-manage-container {
        width: 100%;
        padding: 0 24px;
        box-sizing: border-box;
    }

    .plugin-row {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        align-items: center;
    }

    .plugin-name {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--border-color, #ddd);
        border-radius: 6px;
        font-size: 14px;
        background: var(--input-bg, #fff);
        color: var(--text-primary, #333);
    }

    .plugin-version-date {
        flex: 1;
        padding: 10px 12px;
        font-size: 12px;
        color: var(--text-secondary, #666);
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .plugin-version-date-label {
        font-weight: 500;
    }

    .plugin-version-date-value {
        font-size: 11px;
        color: var(--text-secondary, #888);
    }

    .btn-delete {
        width: 36px;
        height: 36px;
        border: none;
        background: #E53935;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
    }

    .btn-delete:hover {
        background: #C62828;
    }

    .btn-delete:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-update {
        padding: 8px 16px;
        height: 36px;
        border: none;
        background: #2196F3;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
        white-space: nowrap;
    }

    .btn-update:hover {
        background: #1976D2;
    }

    .btn-update:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .install-section {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color, #ddd);
    }

    .install-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .install-row .form-input {
        flex: 1;
        min-width: 200px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary, #666);
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    [data-theme="dark"] .plugin-name {
        background: #333;
        border-color: #555;
        color: #eee;
    }

    [data-theme="dark"] .plugin-version-date-label {
        color: #eee;
    }

    [data-theme="dark"] .plugin-version-date-value {
        color: #aaa;
    }

    .plugin-action-success {
        margin-top: 20px;
        padding: 16px;
        border-radius: 8px;
        background: rgba(76, 175, 80, 0.15);
        border: 1px solid rgba(76, 175, 80, 0.4);
    }

    .plugin-action-success p {
        margin: 0 0 12px 0;
        color: var(--text-primary, #333);
    }

    [data-theme="dark"] .plugin-action-success {
        background: rgba(76, 175, 80, 0.2);
        border-color: rgba(76, 175, 80, 0.5);
    }

    .core-patch-warning {
        background: rgba(255, 152, 0, 0.15) !important;
        border: 1px solid rgba(255, 152, 0, 0.4) !important;
    }

    [data-theme="dark"] .core-patch-warning {
        background: rgba(255, 152, 0, 0.2) !important;
        border-color: rgba(255, 152, 0, 0.5) !important;
    }

    [data-theme="dark"] .core-patch-warning p {
        color: #eee !important;
    }

    [data-theme="dark"] .core-patch-warning ul {
        color: #aaa !important;
    }

    /* ------------------------------------------------------------------ */
    /* Terminal modal                                                       */
    /* ------------------------------------------------------------------ */

    #pm-terminal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.72);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
    }

    #pm-terminal-overlay.active {
        display: flex;
    }

    #pm-terminal-panel {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 10px;
        width: 90%;
        max-width: 820px;
        max-height: 92vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
    }

    #pm-terminal-titlebar {
        padding: 10px 16px;
        border-bottom: 1px solid #30363d;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }

    #pm-terminal-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #f59e0b;
        flex-shrink: 0;
        transition: background 0.3s;
    }

    #pm-terminal-dot.success {
        background: #22c55e;
    }

    #pm-terminal-dot.failure {
        background: #ef4444;
    }

    #pm-terminal-title {
        color: #8b949e;
        font-size: 13px;
        font-family: 'Courier New', Courier, monospace;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #pm-terminal-body {
        flex: 1;
        overflow-y: auto;
        padding: 14px 16px;
        min-height: 280px;
        max-height: 72vh;
    }

    #pm-terminal-output {
        margin: 0;
        font-family: 'Courier New', Courier, monospace;
        font-size: 12.5px;
        line-height: 1.65;
        color: #d1fae5;
        white-space: pre-wrap;
        word-break: break-all;
    }

    #pm-terminal-footer {
        padding: 10px 16px;
        border-top: 1px solid #30363d;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    #pm-terminal-status-msg {
        flex: 1;
        font-size: 13px;
        font-family: 'Courier New', Courier, monospace;
    }

    #pm-terminal-status-msg.success {
        color: #22c55e;
    }

    #pm-terminal-status-msg.failure {
        color: #ef4444;
    }
</style>

<div class="plugin-manage-container">
    {% if core_needs_patch %}
    <div class="core-patch-warning"
        style="padding: 32px 24px; border-radius: 8px; text-align: center; max-width: 600px; margin: 40px auto;">
        <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
        <p style="margin: 0 0 16px 0; color: var(--text-primary, #333); font-weight: bold; font-size: 20px;">
            Core files need to be patched
        </p>
        <p style="margin: 0 0 16px 0; color: var(--text-secondary, #666); font-size: 15px; line-height: 1.6;">
            The pluginmanager plugin requires core changes to work properly.<br>
            The patch is being applied automatically now.
        </p>
        <p style="margin: 0 0 24px 0; color: var(--text-secondary, #666); font-size: 13px; line-height: 1.6;">
            The InkyPi service will restart during this process. Please wait about 30 seconds, then use the button
            below to reload this page.
        </p>
        {% if core_patch_missing %}
        <div
            style="margin: 0 0 24px 0; padding: 16px; background: rgba(0, 0, 0, 0.05); border-radius: 6px; text-align: left;">
            <p style="margin: 0 0 10px 0; font-weight: bold; font-size: 13px; color: var(--text-primary, #333);">
                Missing components before patch:
            </p>
            <ul
                style="margin: 0; padding-left: 24px; color: var(--text-secondary, #666); font-size: 13px; line-height: 1.8;">
                {% for missing in core_patch_missing %}
                <li>{{ missing }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <a href="https://github.com/RobinWts/InkyPi-Plugin-PluginManager/blob/main/pluginmanager/CORE_CHANGES.md"
                target="_blank" class="action-button" style="text-decoration: none; display: inline-block;">
                View Documentation
            </a>
            <button type="button" id="reload-btn" class="action-button" onclick="forceReload()" disabled>
                Reload (30s)
            </button>
        </div>
    </div>
    {% else %}

    <h2 class="form-label" style="margin-bottom: 12px;">Installed third-party plugins</h2>
    <div id="plugins-list">
        {% if third_party_plugins %}
        {% for plugin in third_party_plugins %}
        <div class="plugin-row" data-plugin-id="{{ plugin.id }}">
            <span class="plugin-name">{{ plugin.display_name or plugin.id }}</span>
            <span class="plugin-version-date">
                <span class="plugin-version-date-label">Version timestamp:</span>
                <span class="plugin-version-date-value">{{ plugin.version_date or 'Unknown' }}</span>
            </span>
            <button type="button" class="btn-update" onclick="checkUpdates('{{ plugin.id }}', this)"
                title="Check for updates">check updates</button>
            <button type="button" class="btn-delete" onclick="uninstallPlugin('{{ plugin.id }}', this)"
                title="Uninstall">√ó</button>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <p>No third-party plugins installed.</p>
            <p>Install one from a GitHub repository below.</p>
        </div>
        {% endif %}
    </div>

    <div class="install-section">
        <h2 class="form-label" style="margin-bottom: 12px;">Install from GitHub</h2>
        <div class="install-row">
            <input type="text" id="plugin-url" class="form-input" placeholder="https://github.com/username/repo"
                autocomplete="url">
            <button type="button" id="install-btn" class="action-button" onclick="installPlugin()">Install</button>
        </div>
        <p style="font-size: 13px; color: var(--text-secondary, #666); margin-top: 8px;">
            Only GitHub.com repository URLs are accepted (e.g. https://github.com/username/repo).
        </p>
    </div>

    <div id="plugin-action-success" class="plugin-action-success" style="display: none;">
        <p id="plugin-action-success-msg"></p>
        <button type="button" class="action-button" onclick="reloadPage()">Reload page</button>
    </div>
    {% endif %}
</div>

<!-- Terminal output modal ‚Äî rendered outside .plugin-manage-container so the fixed overlay covers the full viewport -->
<div id="pm-terminal-overlay" role="dialog" aria-modal="true" aria-labelledby="pm-terminal-title">
    <div id="pm-terminal-panel">
        <div id="pm-terminal-titlebar">
            <span id="pm-terminal-dot"></span>
            <span id="pm-terminal-title"></span>
        </div>
        <div id="pm-terminal-body">
            <pre id="pm-terminal-output"></pre>
        </div>
        <div id="pm-terminal-footer" style="display: none;">
            <span id="pm-terminal-status-msg"></span>
            <button type="button" id="pm-terminal-reload-btn" class="action-button" style="display: none;"
                onclick="reloadPage()">Reload page</button>
            <button type="button" id="pm-terminal-close-btn" class="action-button" style="display: none;"
                onclick="closeTerminalModal()">Close</button>
        </div>
    </div>
</div>

<script>
    // -----------------------------------------------------------------------
    // Utilities
    // -----------------------------------------------------------------------

    function forceReload() {
        window.location.reload();
    }

    function showMessage(success, text) {
        if (typeof showResponseModal === 'function') {
            showResponseModal(success ? 'success' : 'failure', text);
        } else {
            alert(text);
        }
    }

    function reloadPage() {
        window.location.href = '{{ url_for("main.main_page") }}';
    }

    // -----------------------------------------------------------------------
    // Terminal modal
    // -----------------------------------------------------------------------

    let _terminalPollInterval = null;

    function openTerminalModal(title, jobId, { reloadOnSuccess = false } = {}) {
        const overlay   = document.getElementById('pm-terminal-overlay');
        const titleEl   = document.getElementById('pm-terminal-title');
        const dotEl     = document.getElementById('pm-terminal-dot');
        const outputEl  = document.getElementById('pm-terminal-output');
        const footer    = document.getElementById('pm-terminal-footer');
        const statusMsg = document.getElementById('pm-terminal-status-msg');
        const reloadBtn = document.getElementById('pm-terminal-reload-btn');
        const closeBtn  = document.getElementById('pm-terminal-close-btn');

        // Reset state
        titleEl.textContent = title;
        dotEl.className = '';
        outputEl.textContent = '';
        footer.style.display = 'none';
        statusMsg.textContent = '';
        statusMsg.className = '';
        reloadBtn.style.display = 'none';
        reloadBtn.textContent = 'Reload page';
        reloadBtn.disabled = false;
        closeBtn.style.display = 'none';

        overlay.classList.add('active');

        // Stop any previous poll that may still be running
        if (_terminalPollInterval !== null) {
            clearInterval(_terminalPollInterval);
            _terminalPollInterval = null;
        }

        let offset = 0;

        _terminalPollInterval = setInterval(async () => {
            try {
                const resp = await fetch(`/pluginmanager-api/job/${jobId}/output?since=${offset}`);
                if (!resp.ok) {
                    // Job not found or server error ‚Äî stop polling
                    _stopTerminalPoll();
                    _finishTerminalModal(false, 'Lost connection to job', reloadOnSuccess);
                    return;
                }
                const data = await resp.json();
                if (data.lines && data.lines.length > 0) {
                    outputEl.textContent += data.lines.join('\n') + '\n';
                    // Auto-scroll to bottom
                    const body = document.getElementById('pm-terminal-body');
                    body.scrollTop = body.scrollHeight;
                }
                offset = data.offset;

                if (data.done) {
                    _stopTerminalPoll();
                    _finishTerminalModal(data.job_success, data.error, reloadOnSuccess);
                }
            } catch (e) {
                // Network error ‚Äî stop polling and report
                _stopTerminalPoll();
                _finishTerminalModal(false, 'Network error: ' + e.message, reloadOnSuccess);
            }
        }, 1000);
    }

    function _stopTerminalPoll() {
        if (_terminalPollInterval !== null) {
            clearInterval(_terminalPollInterval);
            _terminalPollInterval = null;
        }
    }

    const _RELOAD_COUNTDOWN_SEC = 15;

    function _finishTerminalModal(success, errorMsg, reloadOnSuccess) {
        const dotEl     = document.getElementById('pm-terminal-dot');
        const footer    = document.getElementById('pm-terminal-footer');
        const statusMsg = document.getElementById('pm-terminal-status-msg');
        const reloadBtn = document.getElementById('pm-terminal-reload-btn');
        const closeBtn  = document.getElementById('pm-terminal-close-btn');

        dotEl.className = success ? 'success' : 'failure';
        footer.style.display = 'flex';

        if (success) {
            statusMsg.textContent = 'Completed successfully.';
            statusMsg.className = 'success';
            if (reloadOnSuccess) {
                reloadBtn.style.display = '';
                reloadBtn.disabled = true;
                let remaining = _RELOAD_COUNTDOWN_SEC;
                const updateLabel = () => {
                    reloadBtn.textContent = remaining > 0 ? `Reload (${remaining}s)` : 'Reload now';
                };
                updateLabel();
                const countdownId = setInterval(() => {
                    remaining -= 1;
                    updateLabel();
                    if (remaining <= 0) {
                        clearInterval(countdownId);
                        reloadBtn.disabled = false;
                    }
                }, 1000);
            } else {
                closeBtn.style.display = '';
            }
        } else {
            statusMsg.textContent = errorMsg || 'Operation failed.';
            statusMsg.className = 'failure';
            closeBtn.style.display = '';
        }
    }

    function closeTerminalModal() {
        _stopTerminalPoll();
        document.getElementById('pm-terminal-overlay').classList.remove('active');
    }

    // -----------------------------------------------------------------------
    // Plugin operations
    // -----------------------------------------------------------------------

    async function checkUpdates(pluginId, btn) {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Checking...';

        try {
            const resp = await fetch('/pluginmanager-api/check-updates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plugin_id: pluginId })
            });
            const data = await resp.json().catch(() => ({}));

            if (!resp.ok) {
                showMessage(false, data.error || 'Failed to check for updates');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            if (data.has_updates) {
                const confirmed = confirm('Updates available! Do you want to update this plugin?');
                if (confirmed) {
                    await _startUpdateJob(pluginId, btn, originalText);
                } else {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } else {
                alert('No updates available!');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (e) {
            showMessage(false, 'Request failed: ' + e.message);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    async function _startUpdateJob(pluginId, btn, originalText) {
        try {
            const resp = await fetch('/pluginmanager-api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plugin_id: pluginId })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.success && data.job_id) {
                openTerminalModal(`Updating: ${pluginId}`, data.job_id, { reloadOnSuccess: true });
            } else {
                showMessage(false, data.error || 'Update failed');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (e) {
            showMessage(false, 'Request failed: ' + e.message);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    async function uninstallPlugin(pluginId, btn) {
        if (!confirm('Uninstall this plugin? It will be removed from the device.')) {
            return;
        }
        btn.disabled = true;
        try {
            const resp = await fetch('/pluginmanager-api/uninstall', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plugin_id: pluginId })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.success && data.job_id) {
                // Uninstall causes a service restart ‚Äî reload on success
                openTerminalModal(`Uninstalling: ${pluginId}`, data.job_id, { reloadOnSuccess: true });
            } else {
                showMessage(false, data.error || 'Uninstall failed');
                btn.disabled = false;
            }
        } catch (e) {
            showMessage(false, 'Request failed: ' + e.message);
            btn.disabled = false;
        }
    }

    async function installPlugin() {
        const urlInput  = document.getElementById('plugin-url');
        const installBtn = document.getElementById('install-btn');

        if (installBtn.disabled) {
            return;
        }

        const url = (urlInput.value || '').trim();
        if (!url) {
            showMessage(false, 'Please enter a repository URL');
            return;
        }
        if (!url.startsWith('https://')) {
            showMessage(false, 'Only GitHub.com repository URLs are accepted (HTTPS).');
            return;
        }
        try {
            const u = new URL(url);
            const host = u.hostname.toLowerCase();
            if (host !== 'github.com' && host !== 'www.github.com') {
                showMessage(false, 'Only GitHub.com repository URLs are accepted.');
                return;
            }
        } catch (_) {
            showMessage(false, 'Invalid URL.');
            return;
        }

        installBtn.disabled = true;
        installBtn.textContent = 'Starting‚Ä¶';

        try {
            const resp = await fetch('/pluginmanager-api/install', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.success && data.job_id) {
                urlInput.value = '';
                openTerminalModal(`Installing: ${url}`, data.job_id, { reloadOnSuccess: true });
            } else {
                showMessage(false, data.error || 'Install failed');
            }
        } catch (e) {
            showMessage(false, 'Request failed: ' + e.message);
        }

        installBtn.disabled = false;
        installBtn.textContent = 'Install';
    }

    // -----------------------------------------------------------------------
    // Core-patch reload countdown
    // -----------------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        const reloadBtn = document.getElementById('reload-btn');
        if (!reloadBtn) {
            return;
        }
        let remaining = 30;
        const updateLabel = () => {
            reloadBtn.textContent = `Reload (${remaining}s)`;
        };
        updateLabel();
        const intervalId = setInterval(() => {
            remaining -= 1;
            if (remaining <= 0) {
                clearInterval(intervalId);
                reloadBtn.disabled = false;
                reloadBtn.textContent = 'Reload now';
            } else {
                updateLabel();
            }
        }, 1000);
    });
</script>